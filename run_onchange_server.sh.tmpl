#!/bin/bash

{{ if (and (eq .chezmoi.osRelease.id "fedora") (eq .chezmoi.osRelease.variantID "server")) -}}
sudo tee -a /etc/security/limits.d/99-base.conf <<-EOF
* soft nofile 65535
* hard nofile 65535
EOF

sudo tee -a /etc/modprobe.d/sunrpc.conf <<-EOF
options sunrpc tcp_slot_table_entries=128
options sunrpc tcp_max_slot_table_entries=128
EOF

sudo tee -a /etc/sysctl.d/99-sysctl.conf <<-EOF
# Increase TCP buffer sizes for high-speed transfers
net.core.rmem_max=67108864
net.core.wmem_max=67108864
net.core.rmem_default=262144
net.core.wmem_default=262144
net.core.optmem_max=65536

# TCP Memory tuning
net.ipv4.tcp_rmem=4096 87380 67108864
net.ipv4.tcp_wmem=4096 65536 67108864

# Reduce TCP FIN timeout (faster connection closing)
net.ipv4.tcp_fin_timeout=10

# Enable TCP Fast Open (reduces latency for repeated connections)
net.ipv4.tcp_fastopen=3

# Enable TCP BBR congestion control (better than Cubic for modern networks)
net.core.default_qdisc=fq
net.ipv4.tcp_congestion_control=bbr

# Reduce SYN flood attack risk
net.ipv4.tcp_syncookies=1
net.ipv4.tcp_synack_retries=5
net.ipv4.tcp_max_syn_backlog=4096

# Allow more open connections
net.core.somaxconn=65535
net.ipv4.tcp_max_tw_buckets=2000000

# Increase the number of rpc slots for nfs
sunrpc.tcp_slot_table_entries=128

# Increase file descriptors
fs.file-max=2097152

# Increase open file limits per process
fs.nr_open=2097152
fs.inotify.max_user_watches=524288
fs.inotify.max_user_instances=1024

# Reduce swap tendency
vm.swappiness=10

# Enable ASLR (Address Space Layout Randomization)
kernel.randomize_va_space=2

# Enable IP forwarding for Docker networking
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1

# Docker bridge networking
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1

# Disable ICMP redirects (prevents MITM attacks)
net.ipv4.conf.all.accept_redirects=0
net.ipv4.conf.default.accept_redirects=0

# Disable source routing (prevents IP spoofing)
net.ipv4.conf.all.accept_source_route=0
net.ipv4.conf.default.accept_source_route=0

# Reboot on kernel panic
kernel.panic=10
kernel.panic_print=3
kernel.softlockup_panic=1
EOF
sudo sysctl -p

# General packages
sudo dnf install -y @development-tools @virtualization \
    dnf-automatic dnf-plugins-core golang rust cargo htop zsh unar git git-lfs \
    openssl curl htop zsh unar git git-lfs lsd fd-find ripgrep fzf tldr ncdu \
    zoxide jq lm_sensors age duf neovim python3-neovim anacron tuned \
    udisks2-btrfs nfs-utils fastfetch xz-devel kernel-devel kernel-headers

# Add docker
sudo dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
sudo dnf install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Make zsh default shell
if type zsh >/dev/null; then
    sudo chsh -s $(which zsh) $USER
fi

# Check if NVIDIA GPU is available
if lspci | grep -i nvidia > /dev/null; then
    echo "NVIDIA GPU detected. Adding CUDA repository..."

    # Determine the distribution version in the format 'fedoraXX'
    DISTRO=$(cat /etc/os-release | grep -oP '(?<=^ID=).+' | tr -d '"')
    VERSION=$(cat /etc/os-release | grep -oP '(?<=^VERSION_ID=).+' | tr -d '"')
    DISTRO_VERSION="fedora$VERSION"

    # Add the appropriate CUDA repo based on the distribution
    sudo dnf config-manager --add-repo "https://developer.download.nvidia.com/compute/cuda/repos/$DISTRO_VERSION/x86_64/cuda-$DISTRO_VERSION.repo"
    sudo dnf install cuda-toolkit -y
fi

# Extra tweaks
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=nfs
sudo firewall-cmd --reload

{{ end -}}
