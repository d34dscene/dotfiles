#!/bin/bash

{{ if (and (eq .chezmoi.osRelease.id "fedora") (eq .chezmoi.osRelease.variantID "server")) -}}
sudo tee -a /etc/security/limits.d/base.conf <<-EOF
* soft nofile 65535
* hard nofile 65535
EOF

sudo tee -a /etc/modprobe.d/sunrpc.conf <<-EOF
options sunrpc tcp_slot_table_entries=128
options sunrpc tcp_max_slot_table_entries=128
EOF

sudo tee -a /etc/sysctl.d/99-sysctl.conf <<-EOF
# Network tuning for NFS
net.core.rmem_max=16777216
net.core.wmem_max=16777216
net.ipv4.tcp_rmem=4096 87380 16777216
net.ipv4.tcp_wmem=4096 87380 16777216
net.ipv4.tcp_fin_timeout=10

# Increase file descriptors
fs.file-max=2097152
EOF
sudo sysctl -p

# General packages
sudo dnf install -y dnf-automatic dnf-plugins-core htop zsh unar git git-lfs \
    openssl curl lsd fd-find ripgrep fzf tldr ncdu zoxide jq lm_sensors age \
    duf neovim python3-neovim anacron tuned udisks2-btrfs nfs-utils \
    fastfetch xz-devel kernel-devel kernel-headers

# Add docker
sudo dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
sudo dnf install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

{{ end -}}
