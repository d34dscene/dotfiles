#!/usr/bin/env bash

log() { echo -e "\033[1;32m[+]\033[0m $1"; }

{{ if (and (eq .chezmoi.osRelease.id "fedora") (eq .chezmoi.osRelease.variantID "server")) -}}
log "Configuring kernel..."
sudo tee /etc/security/limits.d/99-base.conf <<-EOF
* soft nofile 1048576
* hard nofile 1048576
EOF

sudo tee /etc/modprobe.d/sunrpc.conf <<-EOF
options sunrpc tcp_slot_table_entries=128
options sunrpc tcp_max_slot_table_entries=128
EOF

sudo tee /etc/sysctl.d/99-sysctl.conf <<-EOF
# Allow larger listen backlog for busy services
net.core.somaxconn = 4096

# Reasonable SYN backlog
net.ipv4.tcp_max_syn_backlog = 4096

# Keep SYN cookies enabled (default, but explicit is fine)
net.ipv4.tcp_syncookies = 1

# Faster reuse of TIME_WAIT sockets (safe on modern kernels)
net.ipv4.tcp_tw_reuse = 1

# Improve handling of broken MTU paths
net.ipv4.tcp_mtu_probing = 1

# Reduce swap aggressiveness on servers
vm.swappiness = 10

# Increase inotify limits (important for containers / dev tools)
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 1024

# Docker / container networking
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1

# Basic network hardening
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# Reboot on kernel panic
kernel.panic = 30
kernel.panic_on_oops = 1
EOF
sudo sysctl -p

# General packages
log "Installing general packages..."
sudo dnf install -y @development-tools @virtualization \
    dnf-automatic dnf-plugins-core golang rust cargo htop zsh unar git git-lfs \
    openssl curl htop zsh unar git git-lfs lsd fd-find ripgrep fzf tldr ncdu \
    zoxide jq lm_sensors age duf neovim python3-neovim anacron tuned nss-mdns \
    udisks2-btrfs nfs-utils fastfetch xz-devel kernel-devel kernel-headers pipx

# Add docker
log "Installing docker..."
sudo dnf config-manager addrepo --from-repofile="https://download.docker.com/linux/fedora/docker-ce.repo"
sudo dnf install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y
sudo groupadd docker
sudo usermod -aG docker $USER
sudo systemctl enable docker.service
sudo systemctl enable containerd.service
sudo systemctl enable --now avahi-daemon.service

# Make zsh default shell
if type zsh >/dev/null; then
    sudo chsh -s $(which zsh) $USER
fi

# Check if NVIDIA GPU is available
if lspci | grep -i nvidia > /dev/null; then
    log "NVIDIA GPU detected. Adding CUDA repository..."

    sudo dnf install -y \
        https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
        https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm

    # Add the appropriate CUDA repo based on the distribution
    sudo dnf install akmod-nvidia xorg-x11-drv-nvidia-cuda cuda-toolkit -y
fi

# Poweroff on button press
sudo tee /etc/systemd/logind.conf <<-EOF
[Login]
HandlePowerKey=poweroff
EOF

# NFS 
log "Setting up NFS..."
mkdir -p /share
sudo tee /etc/exports <<-EOF
/share 192.168.1.0/24(rw,sync,all_squash,no_subtree_check,crossmnt,anonuid=1000,anongid=1000)
/share 10.0.10.0/24(rw,sync,all_squash,no_subtree_check,crossmnt,anonuid=1000,anongid=1000)
EOF

# Firewall
log "Setting up firewall..."
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=nfs
sudo firewall-cmd --reload

{{ end -}}
